<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">


<dom-module id="apply-operation-step">
  <template>
    <style include="shared-styles">
        :host {
            display: block;
            height: 100%;
            margin: 0;
            
            @apply --typography;
        }
        
        div.container{
            height: 100%;
            margin: 0;
            @apply(--layout-vertical);
        }
        div.slotted{
            @apply(--layout-flex);
        }
        div.buttons{
            text-align: right;
        }
        .title{
          padding: 4px 0;
          margin: 0;
        }
    </style>
    
    <slot name="loader"></slot>
    
    <iron-ajax
        id="xhr"
        method="[[method]]"
        on-response="_onResponse"
        on-error="_onError"
        handle-as="json"
        content-type="application/json"
        loading="{{loading}}"
        body="[[operation]]"
        headers="[[headers]]"
        url="[[url]]"></iron-ajax>
    
    <div class="container">
        <slot name="title" class="title"></slot>
        
        <div class="slotted">
            <slot></slot>
        </div>
        
        <div class="buttons">
            <paper-button on-click="_runOperation" disabled="[[loading]]">Run</paper-button>
        </div>
    </div>
    
  </template>

  <script>
    /**
     * `apply-operation-step`
     * Apply operation step webcomponent
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ApplyOperationStep extends Polymer.Element {
        static get is() { return 'apply-operation-step'; }
        static get properties() {
            return {
                operation: Object,
                result: {
                    type: Object,
                    notify: true
                },
                url: {
                    type: String
                },
                method: {
                    type: String,
                    value: 'POST'
                },
                headers: Object,
                loading: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                }
            };
        }

        ready(){
            super.ready();
            console.log('operation apply ready', this.operation, this.url, this.headers);
        }

        _runOperation(ev){
            console.log('run operation', this.operation, this.$.xhr);
            this.$.xhr.generateRequest();
        }
        
        _onResponse(ev){
            var response = ev.detail;
            var response_object = response.response;
            console.log('step operation review response', response, response_object);
            this.set('result', response_object);
        }
        
        _onError(ev){
            var response = ev.detail;
            console.log('ERROR! step operation review', response);
        }
    }

    window.customElements.define(ApplyOperationStep.is, ApplyOperationStep);
  </script>
</dom-module>
